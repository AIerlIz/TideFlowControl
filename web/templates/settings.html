<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #444; text-align: center; }
        nav { text-align: center; margin-bottom: 20px; }
        nav a { text-decoration: none; color: #007bff; padding: 10px 15px; border-radius: 5px; transition: background-color 0.3s; }
        nav a:hover, nav a.active { background-color: #007bff; color: #fff; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group small { color: #666; }
        .btn { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .btn:hover { background-color: #0056b3; }
        .restart-warning { color: #dc3545; font-weight: bold; }
        #message { margin-top: 15px; text-align: center; font-weight: bold; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>设置</h1>
        <nav>
            <a href="/">仪表盘</a>
            <a href="/settings" class="active">设置</a>
        </nav>
        <form id="settings-form">
            <div class="form-group">
                <label for="DOWNLOAD_LIMIT_GB">下载限制 (GB)</label>
                <input type="number" id="DOWNLOAD_LIMIT_GB" name="DOWNLOAD_LIMIT_GB" required>
            </div>
            <div class="form-group">
                <label for="RESET_TIME">每日重置时间 (HH:MM)</label>
                <input type="text" id="RESET_TIME" name="RESET_TIME" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" required>
            </div>
            <div class="form-group">
                <label for="ALLOWED_TIME_WINDOWS">允许下载的时间窗口</label>
                <textarea id="ALLOWED_TIME_WINDOWS" name="ALLOWED_TIME_WINDOWS" placeholder="例如: 08:00-12:00,14:00-18:00"></textarea>
                <small>格式为 HH:MM-HH:MM，多个窗口用逗号分隔。</small>
            </div>
            <hr>
            <p class="restart-warning">以下设置需要重启应用才能生效</p>
            <div class="form-group">
                <label for="CONCURRENT_DOWNLOADS">并发下载数</label>
                <input type="number" id="CONCURRENT_DOWNLOADS" name="CONCURRENT_DOWNLOADS" required>
            </div>
            <div class="form-group">
                <label for="HTTP_URLS">HTTP(S) 链接</label>
                <textarea id="HTTP_URLS" name="HTTP_URLS" placeholder="每行一个链接"></textarea>
            </div>
            <div class="form-group">
                <label for="MAGNET_LINKS">磁力链接</label>
                <textarea id="MAGNET_LINKS" name="MAGNET_LINKS" placeholder="每行一个链接"></textarea>
            </div>
            <button type="submit" class="btn">保存设置</button>
        </form>
        <div id="message"></div>
    </div>

    <script>
        const form = document.getElementById('settings-form');
        const messageEl = document.getElementById('message');

        // 加载当前设置
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                form.DOWNLOAD_LIMIT_GB.value = data.DOWNLOAD_LIMIT_GB;
                form.RESET_TIME.value = data.RESET_TIME;
                form.ALLOWED_TIME_WINDOWS.value = data.ALLOWED_TIME_WINDOWS.map(w => w.join('-')).join(',');
                form.CONCURRENT_DOWNLOADS.value = data.CONCURRENT_DOWNLOADS;
                form.HTTP_URLS.value = data.HTTP_URLS.join('\n');
                form.MAGNET_LINKS.value = data.MAGNET_LINKS.join('\n');
            });

        // 保存设置
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            messageEl.textContent = '';

            const formData = new FormData(form);
            const data = {
                DOWNLOAD_LIMIT_GB: parseInt(formData.get('DOWNLOAD_LIMIT_GB')),
                RESET_TIME: formData.get('RESET_TIME'),
                ALLOWED_TIME_WINDOWS: formData.get('ALLOWED_TIME_WINDOWS').split(',').map(s => s.trim().split('-')),
                CONCURRENT_DOWNLOADS: parseInt(formData.get('CONCURRENT_DOWNLOADS')),
                HTTP_URLS: formData.get('HTTP_URLS').split('\n').filter(Boolean),
                MAGNET_LINKS: formData.get('MAGNET_LINKS').split('\n').filter(Boolean)
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    messageEl.textContent = '设置已保存！部分设置需要重启生效。';
                    messageEl.className = 'success';
                } else {
                    messageEl.textContent = `保存失败: ${result.message || '未知错误'}`;
                    messageEl.className = 'error';
                }
            })
            .catch(error => {
                messageEl.textContent = `请求失败: ${error}`;
                messageEl.className = 'error';
            });
        });
    </script>
</body>
</html>
